console.log("Leet2Git background script loaded");const w=new Map,m=new Map,$=new Map;function L(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=new Uint8Array(e);return crypto.getRandomValues(o),Array.from(o,r=>t[r%t.length]).join("")}function v(e){return e.split("-").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join("")}async function p(){try{const e=await chrome.storage.local.get(["pending","auth"]),t=e.pending||[],o=e.auth;if(o&&o.connected){const r=t.length>0?t.length.toString():"";chrome.action.setBadgeText({text:r}),chrome.action.setBadgeBackgroundColor({color:"#3B82F6"})}else chrome.action.setBadgeText({text:""})}catch(e){console.error("Error updating badge:",e)}}chrome.webRequest.onBeforeRequest.addListener(e=>{if(e.method==="POST"&&e.requestBody&&e.requestBody.raw)try{const t=e.requestBody.raw[0].bytes,r=new TextDecoder().decode(t),s=JSON.parse(r);if(s.typed_code&&s.lang&&s.question_id){const a={code:s.typed_code,lang:s.lang,question_id:s.question_id,timestamp:Date.now()};m.set(s.question_id,a),console.log(`[Leet2Git] Code captured for question ${s.question_id}`)}}catch(t){console.error("[Leet2Git] Failed to parse submit request:",t)}return{}},{urls:["*://leetcode.com/problems/*/submit/"]},["requestBody"]);chrome.tabs.onUpdated.addListener((e,t,o)=>{if(t.url&&o.url&&o.url.includes("leetcode.com/problems/")){const r=o.url.match(/\/problems\/([^\/]+)/);if(r){const s=r[1];w.set(e,{slug:s,submissionCode:null}),console.log(`[Leet2Git] Tab ${e} navigated to problem: ${s}`)}}});chrome.tabs.onRemoved.addListener(e=>{w.delete(e),console.log(`[Leet2Git] Cleaned up data for closed tab ${e}`)});chrome.runtime.onInstalled.addListener(()=>{console.log("Leet2Git extension installed"),p()});chrome.runtime.onStartup.addListener(()=>{p()});chrome.webRequest.onCompleted.addListener(async e=>{if(e.statusCode!==200||!e.tabId)return;const t=e.url.match(/\/submissions\/detail\/(\d+)\/check\//);if(!t)return;const o=t[1];console.log(`[Leet2Git] Intercepted submission check: ${o}`),setTimeout(async()=>{try{let r=null,s=null;for(const[a,n]of m.entries())if(n&&n.timestamp>Date.now()-3e5){r=n,s=a;break}if(!r){console.log(`[Leet2Git] No recent code found for submission ${o}`);return}try{const a=await fetch(e.url,{method:"GET",credentials:"include"});if(a.ok){const n=await a.text();let c;try{c=JSON.parse(n)}catch{if(n.includes('"status_msg":"Accepted"')||n.includes("Accepted")&&!n.includes("Wrong Answer")&&!n.includes("Time Limit Exceeded"))c={status_msg:"Accepted"};else{console.log(`[Leet2Git] Submission ${o} not accepted`);return}}c&&c.status_msg==="Accepted"?(console.log(`[Leet2Git] Submission ${o} confirmed accepted`),await y(o,e.tabId,c)):console.log(`[Leet2Git] Submission ${o} status: ${(c==null?void 0:c.status_msg)||"unknown"}`)}else console.log(`[Leet2Git] Could not fetch submission result: ${a.status}`)}catch(a){console.log(`[Leet2Git] Fetch error, assuming accepted for recent code: ${a.message}`),await y(o,e.tabId,null)}}catch(r){console.error("[Leet2Git] Error processing submission:",r)}},3e3)},{urls:["https://leetcode.com/submissions/detail/*/check/"]});async function y(e,t,o=null){try{console.log(`[Leet2Git] Processing accepted submission: ${e}`);let r=null,s=null;for(const[k,b]of m.entries())if(b.timestamp>Date.now()-6e5){r=b,s=k;break}if(!r){console.warn(`[Leet2Git] No recent code record found for submission ${e}`);return}const a=w.get(t);if(!a||!a.slug){console.warn(`[Leet2Git] No tab info found for submission ${e}`);return}const l={id:`${a.slug}-${Date.now()}`,submissionId:e,title:v(a.slug),slug:a.slug,difficulty:"Level",folderPath:"Problems",code:r.code,language:r.lang,runtime:"N/A",memory:"N/A",timestamp:Date.now()};console.log(`[Leet2Git] Solution payload created for ${a.slug}`),s&&m.delete(s);const g=await chrome.storage.local.get(["pending","solvedSlugs"]),u=g.pending||[],i=new Set(g.solvedSlugs||[]),d=`${a.slug}-${r.lang}`,h=Date.now(),f=$.get(d);if(f&&h-f<3e5){console.log("[Leet2Git] Ignoring duplicate submission within 5 minutes");return}u.push(l),$.set(d,h),i.has(a.slug)?console.log(`[Leet2Git] Problem already solved in different language, allowing upload but not updating stats: ${a.slug}`):(i.add(a.slug),await S(l),console.log(`[Leet2Git] Updated stats for new problem: ${a.slug}`)),await chrome.storage.local.set({pending:u,solvedSlugs:Array.from(i)}),await p(),console.log(`[Leet2Git] Successfully captured: ${l.title} (${r.lang})`)}catch(r){console.error("[Leet2Git] Error processing submission:",r)}}async function S(e){try{const{stats:t={streak:0,counts:{easy:0,medium:0,hard:0},recentSolves:[],lastSolveDate:null}}=await chrome.storage.local.get("stats"),o=e.difficulty.toLowerCase();t.counts[o]!==void 0&&(t.counts[o]++,console.log(`[Leet2Git] Updated ${o} count to ${t.counts[o]}`));const r=new Date().toDateString(),s=t.lastSolveDate;if(!s)t.streak=1,t.lastSolveDate=r,console.log("[Leet2Git] Started streak with first solve");else if(s===r)console.log(`[Leet2Git] Already solved today, streak remains ${t.streak}`);else{const a=new Date(s),n=new Date(r),c=Math.floor((n.getTime()-a.getTime())/(1e3*60*60*24));c===1?(t.streak++,t.lastSolveDate=r,console.log(`[Leet2Git] Consecutive day! Streak increased to ${t.streak}`)):(t.streak=1,t.lastSolveDate=r,console.log(`[Leet2Git] Streak broken (${c} days gap), reset to 1`))}t.recentSolves.unshift({id:e.id,title:e.title,language:e.language,difficulty:e.difficulty,timestamp:e.timestamp}),t.recentSolves=t.recentSolves.slice(0,10),await chrome.storage.local.set({stats:t}),console.log(`[Leet2Git] Stats updated for ${e.title}, streak: ${t.streak}`)}catch(t){console.error("Error updating stats:",t)}}async function D(e,t,o=!1){try{const r=o?`Bearer ${e}`:`token ${e}`,s=await fetch("https://api.github.com/user",{headers:{Authorization:r,Accept:"application/vnd.github.v3+json"}});if(!s.ok){t({success:!1,error:"Invalid GitHub token"});return}const a=await s.json(),n={token:e,username:a.login,email:a.email||"",connected:!0,authType:o?"oauth":"pat"};await chrome.storage.local.set({auth:n}),t({success:!0,username:a.login,auth:n})}catch(r){console.error("Error verifying GitHub token:",r),t({success:!1,error:"Failed to verify token"})}}async function G(e){console.log("[OAuth] Starting OAuth login flow");try{const t="Ov23liPVnJxvGsF4Y9qm",o=chrome.identity.getRedirectURL();console.log("[OAuth] Redirect URI:",o);const r=L(32);await chrome.storage.local.set({oauth_state:r}),console.log("OAuth redirect URI:",o);const s=new URL("https://github.com/login/oauth/authorize");s.searchParams.set("client_id",t),s.searchParams.set("redirect_uri",o),s.searchParams.set("scope","repo user:email"),s.searchParams.set("state",r),console.log("[OAuth] Launching web auth flow with URL:",s.toString()),chrome.identity.launchWebAuthFlow({url:s.toString(),interactive:!0},async a=>{if(chrome.runtime.lastError){console.error("[OAuth] Chrome runtime error:",chrome.runtime.lastError),e({success:!1,error:chrome.runtime.lastError.message});return}if(!a){e({success:!1,error:"No redirect URL received"});return}try{const n=new URL(a),c=n.searchParams.get("code"),l=n.searchParams.get("state"),{oauth_state:g}=await chrome.storage.local.get("oauth_state");if(await chrome.storage.local.remove("oauth_state"),!l||l!==g){console.error("OAuth state mismatch - possible CSRF attack"),e({success:!1,error:"Security verification failed"});return}if(!c){e({success:!1,error:"No authorization code received"});return}console.log("Got authorization code, exchanging for token...");const u=await fetch("http://localhost:5000/api/github/oauth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:c})}),i=await u.json();if(!u.ok||i.error){console.error("Token exchange error:",i),e({success:!1,error:i.error||"Failed to exchange code for token"});return}const d={token:i.access_token,username:i.user.login,email:i.user.email||"",connected:!0,authType:"oauth",userInfo:i.user};await chrome.storage.local.set({auth:d}),e({success:!0,username:i.user.login,auth:d})}catch(n){console.error("OAuth processing error:",n),e({success:!1,error:n.message})}})}catch(t){console.error("[OAuth] Login error:",t),e({success:!1,error:(t==null?void 0:t.message)||"OAuth initialization failed"})}}async function A(e){try{const t=await chrome.storage.local.get(["auth"]);e({success:!0,auth:t.auth||null})}catch(t){console.error("Error handling auth:",t),e({success:!1,error:t.message})}}async function C(e){try{const t=await chrome.storage.local.get(["stats","pending","auth","config"]),o={stats:t.stats||{streak:0,counts:{easy:0,medium:0,hard:0},recentSolves:[]},pending:t.pending||[],auth:t.auth||null,config:t.config||{owner:"",repo:"leetcode-solutions",branch:"main",private:!1,folderStructure:"topic",includeDescription:!0,includeTestCases:!1}};e({success:!0,data:o})}catch(t){console.error("Error getting home data:",t),e({success:!1,error:t.message})}}async function T(e,t){try{await chrome.storage.local.set({config:e}),t({success:!0})}catch(o){console.error("Error updating config:",o),t({success:!1,error:o.message})}}async function P(e){try{const t=await chrome.storage.local.get(["pending","auth","config"]),o=t.pending||[];if(o.length===0){e({success:!1,error:"No pending solutions to push"});return}const r=t.auth;if(!r||!r.token){e({success:!1,error:"GitHub authentication required"});return}const s=t.config||{owner:r.username,repo:"leetcode-solutions",branch:"main",private:!1,folderStructure:"topic",includeDescription:!0,includeTestCases:!1};await q(r.token,s,r.authType);let a=0;const n=[];for(const c of o)try{await x(c,r,s),a++,n.push({success:!0,title:c.title})}catch(l){console.error(`Failed to push ${c.title}:`,l),n.push({success:!1,title:c.title,error:l.message})}await chrome.storage.local.set({pending:[]}),await p(),e({success:!0,count:a,results:n,message:`Pushed ${a}/${o.length} solutions`})}catch(t){console.error("Error handling push:",t),e({success:!1,error:t.message})}}async function q(e,t,o="pat"){const r=`https://api.github.com/repos/${t.owner}/${t.repo}`,s=o==="oauth"?`Bearer ${e}`:`token ${e}`;try{const a=await fetch(r,{headers:{Authorization:s,Accept:"application/vnd.github.v3+json"}});if(a.ok){console.log(`Repository ${t.owner}/${t.repo} exists`);return}if(a.status===404){console.log(`Creating repository ${t.owner}/${t.repo}`);const n=await fetch("https://api.github.com/user/repos",{method:"POST",headers:{Authorization:s,Accept:"application/vnd.github.v3+json","Content-Type":"application/json"},body:JSON.stringify({name:t.repo,description:"LeetCode solutions managed by Leet2Git extension",private:t.private||!1,auto_init:!0})});if(!n.ok){const c=await n.json();throw new Error(`Failed to create repository: ${c.message}`)}console.log(`Repository ${t.owner}/${t.repo} created successfully`)}else throw new Error(`Failed to check repository: ${a.statusText}`)}catch(a){throw console.error("Repository check/creation error:",a),a}}async function x(e,t,o){const r=E(e),s=U(e),a=_(e);return console.log(`Pushing to GitHub: ${s}/${r}`),await O({token:t.token,owner:o.owner,repo:o.repo,branch:o.branch||"main",path:`${s}/${r}`,content:a,message:`Add solution: ${e.title}`,authType:t.authType||"pat"})}function E(e){const t=j(e.language);return`${e.title.replace(/[^a-zA-Z0-9]/g,"")}.${t}`}function U(e,t){const o=e.folderPath||"Problems";return console.log(`[Leet2Git] Using user-selected folder path: ${o}`),o}function _(e,t){let o="";return o+=`/*
 * @lc app=leetcode id=${e.submissionId} lang=${e.language}
 *
 * ${e.title}
 * 
 * Difficulty: ${e.difficulty}
 * Category: ${e.tag}
 * Runtime: ${e.runtime}
 * Memory: ${e.memory}
 */

`,o+=e.code,o}function j(e){const t={javascript:"js",python:"py",python3:"py",java:"java","c++":"cpp",cpp:"cpp",c:"c","c#":"cs",csharp:"cs",ruby:"rb",swift:"swift",go:"go",golang:"go",scala:"scala",kotlin:"kt",rust:"rs",php:"php",typescript:"ts",mysql:"sql",postgresql:"sql"},o=(e||"").toLowerCase().trim();return t[o]||"py"}async function O({token:e,owner:t,repo:o,branch:r,path:s,content:a,message:n,authType:c}){const l=`https://api.github.com/repos/${t}/${o}/contents/${s}`,g=c==="oauth"?`Bearer ${e}`:`token ${e}`;let u=null;try{const h=await fetch(l,{headers:{Authorization:g,Accept:"application/vnd.github.v3+json"}});h.ok&&(u=(await h.json()).sha)}catch{}const i={message:n||`Update ${s}`,content:btoa(unescape(encodeURIComponent(a))),branch:r};u&&(i.sha=u);const d=await fetch(l,{method:"PUT",headers:{Authorization:g,Accept:"application/vnd.github.v3+json","Content-Type":"application/json"},body:JSON.stringify(i)});if(!d.ok){const h=await d.json();throw new Error(`GitHub API error: ${h.message||d.statusText}`)}return{success:!0}}chrome.runtime.onMessage.addListener((e,t,o)=>{var r;switch(e.type){case"submission_accepted":y(e.submissionId,e.tabId||((r=t.tab)==null?void 0:r.id)),o({success:!0});break;case"auth":e.data&&e.data.token?D(e.data.token,o):A(o);break;case"oauthLogin":console.log("[Background] Received oauthLogin message"),G(o);break;case"push":P(o);break;case"getHomeData":C(o);break;case"updateConfig":T(e.payload,o);break;case"updateBadge":p(),o({success:!0});break;default:console.warn("Unknown message type:",e.type)}return!0});
